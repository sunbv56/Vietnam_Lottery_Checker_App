<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dò Vé Số AI - Kiểm Tra Vé Số Thông Minh</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff5e3a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/8610/8610944.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Flatpickr for Premium Date Selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;800&display=swap');

        :root {
            --accent-primary: #ff5e3a;
            --accent-secondary: #ff2a6d;
            --transition-speed: 0.3s;
        }

        /* --- Dark Theme (Default) --- */
        [data-theme="dark"],
        :root:not([data-theme]) {
            --bg-main: #0a0b14;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --input-bg: rgba(255, 255, 255, 0.05);
            --status-bar: #0a0b14;
            --shadow-color: rgba(0, 0, 0, 0.8);
            --bg-gradient:
                radial-gradient(circle at 10% 20%, rgba(255, 94, 58, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 42, 109, 0.05) 0%, transparent 40%);
        }

        /* --- Light Theme --- */
        [data-theme="light"] {
            --bg-main: #f0f2f5;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
            --text-main: #1a1a1b;
            --text-muted: #64748b;
            --input-bg: rgba(255, 255, 255, 0.8);
            --status-bar: #f0f2f5;
            --shadow-color: rgba(0, 0, 0, 0.06);
            --bg-gradient:
                radial-gradient(circle at 10% 20%, rgba(255, 94, 58, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 42, 109, 0.15) 0%, transparent 40%);
        }

        /* --- Imperial Gold --- */
        [data-theme="gold"] {
            --bg-main: #120e06;
            --accent-primary: #fbbf24;
            --accent-secondary: #d97706;
            --glass-bg: rgba(251, 191, 36, 0.05);
            --glass-border: rgba(251, 191, 36, 0.15);
            --text-main: #fef3c7;
            --text-muted: #b45309;
            --input-bg: rgba(251, 191, 36, 0.1);
            --status-bar: #120e06;
            --shadow-color: rgba(0, 0, 0, 0.8);
            --bg-gradient:
                radial-gradient(circle at 10% 20%, rgba(251, 191, 36, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(217, 119, 6, 0.08) 0%, transparent 40%);
        }

        /* --- Cyberpunk Theme --- */
        [data-theme="cyberpunk"] {
            --bg-main: #050505;
            --accent-primary: #00ffcc;
            --accent-secondary: #ff00ff;
            --glass-bg: rgba(0, 255, 204, 0.03);
            --glass-border: rgba(255, 0, 255, 0.2);
            --text-main: #ffffff;
            --text-muted: #00ffcc;
            --input-bg: rgba(255, 0, 255, 0.05);
            --status-bar: #050505;
            --shadow-color: rgba(0, 0, 255, 0.5);
            --bg-gradient:
                radial-gradient(circle at 10% 20%, rgba(0, 255, 204, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 255, 0.1) 0%, transparent 40%);
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-main);
            background-image: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-main);
            overflow-x: hidden;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        .premium-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px 0 var(--shadow-color);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .mirror {
            transform: scaleX(-1);
        }

        /* custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #drop-zone {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #drop-zone:hover {
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.01);
        }

        .history-card {
            transition: transform 0.2s;
        }

        .history-card:hover {
            transform: translateX(5px);
            background: var(--glass-bg);
            border-color: var(--glass-border);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
        }

        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-hover:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 94, 58, 0.3);
        }

        /* Premium Popup Styles */
        .win-glow {
            animation: win-glow-pulse 2s infinite;
            text-shadow: 0 0 20px var(--accent-primary);
            opacity: 0.95;
        }

        @keyframes win-glow-pulse {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.02);
                filter: brightness(1.3);
            }
        }

        .prize-badge {
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .gold-glow {
            color: #fbbf24;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        .silver-glow {
            color: #cbd5e1;
            text-shadow: 0 0 15px rgba(203, 213, 225, 0.4);
        }

        .modal-content-glass {
            background: var(--bg-main);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border);
            opacity: 0.98;
        }

        @media (max-width: 768px) {
            .modal {
                align-items: flex-end;
            }

            .modal-content-glass {
                border-radius: 2.5rem 2.5rem 0 0 !important;
                margin: 0 !important;
                max-height: 95vh !important;
                width: 100% !important;
                padding-top: 3rem !important;
                animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }

                to {
                    transform: translateY(0);
                }
            }

            .mobile-handle {
                display: block;
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                margin: 0 auto;
                position: absolute;
                top: 12px;
                left: 50%;
                transform: translateX(-50%);
            }

            /* Mobile History Drawer */
            .history-drawer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-main);
                border-top: 1px solid var(--glass-border);
                border-radius: 2rem 2rem 0 0;
                z-index: 500;
                transform: translateY(100%);
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                max-height: 80vh;
                display: flex;
                flex-direction: column;
                padding: 2rem 1.5rem 1.5rem;
                box-shadow: 0 -10px 40px var(--shadow-color);
            }

            .history-drawer.open {
                transform: translateY(0);
            }

            .history-drawer-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(4px);
                z-index: 499;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            .history-drawer-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
        }

        @media (min-width: 769px) {
            .mobile-handle {
                display: none;
            }
        }

        .camera-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
        }

        .camera-wrapper {
            width: fit-content;
            height: 100vh;
            max-width: 100vw;
            background: #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0, 0, 0, 1);
            animation: modalPop 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(1.05);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .camera-video-container {
            height: 65vh;
            width: auto;
            min-width: 320px;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-video-container video {
            height: 100%;
            width: auto;
            max-width: 100vw;
            object-fit: contain;
        }

        .camera-controls-container {
            flex: 1;
            background: linear-gradient(180deg, #121215 0%, #0a0b14 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 2rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .camera-guide-overlay {
            position: absolute;
            inset: 2rem;
            border: 2px solid rgba(255, 165, 0, 0.2);
            border-radius: 2rem;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .camera-guide-overlay::before {
            content: '';
            width: 80%;
            height: 40%;
            border: 1px dashed rgba(255, 165, 0, 0.5);
            border-radius: 1rem;
        }

        .camera-guide-overlay::after {
            content: 'CĂN VÉ SỐ VÀO VÙNG NÈ';
            position: absolute;
            bottom: 1.5rem;
            color: #ffa500;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.6);
            padding: 6px 16px;
            border-radius: 99px;
            backdrop-filter: blur(5px);
        }

        .confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1001;
        }

        /* FIX: Flatpickr Year Selection Visibility */
        .flatpickr-current-month {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
            padding: 0 10px !important;
        }

        .flatpickr-current-month .numInputWrapper {
            width: 75px !important;
            flex-shrink: 0 !important;
        }

        .flatpickr-current-month input.cur-year {
            background: rgba(255, 255, 255, 0.05) !important;
            border-radius: 6px !important;
            padding: 2px 8px !important;
            font-weight: 800 !important;
            color: #fff !important;
        }
    </style>
</head>

<body class="p-4 md:p-12">
    <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Side: Main Controls -->
        <div class="lg:col-span-2 space-y-8">
            <header class="flex justify-between items-center animate-fade-in">
                <div onclick="resetUI()" class="cursor-pointer group">
                    <h1 class="text-4xl font-extrabold tracking-tight transition-transform group-active:scale-95">
                        <span class="gradient-text">Dò Vé Số AI</span>
                    </h1>
                    <p class="text-[var(--text-muted)] text-sm mt-1">Dò vé số thông minh với AI</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="open-history" onclick="toggleMobileHistory()"
                        class="lg:hidden w-10 h-10 rounded-full premium-glass flex items-center justify-center text-[var(--text-muted)] hover:text-white transition-colors">
                        <i class="fas fa-history"></i>
                    </button>
                    <button id="open-settings"
                        class="w-10 h-10 rounded-full premium-glass flex items-center justify-center text-[var(--text-muted)] hover:text-white transition-colors">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>

            <main class="space-y-6">
                <!-- Action Area -->
                <div id="drop-zone"
                    class="premium-glass rounded-3xl p-10 text-center border-2 border-dashed border-[var(--glass-border)] cursor-pointer animate-fade-in"
                    style="animation-delay: 0.1s">
                    <div id="upload-ui">
                        <div
                            class="mb-6 inline-flex w-20 h-20 items-center justify-center rounded-2xl bg-gradient-to-br from-orange-500/20 to-pink-500/20 text-orange-500">
                            <i class="fas fa-cloud-upload-alt text-4xl"></i>
                        </div>
                        <h2 class="text-xl font-bold mb-2">Quét vé số của bạn</h2>
                        <p class="text-[var(--text-muted)] text-sm">Kéo thả ảnh vào vùng này hoặc bấm trực tiếp để tải
                            lên</p>
                        <p class="text-[11px] text-[var(--text-muted)] mt-2 mb-8 uppercase tracking-widest font-bold">Hỗ
                            trợ JPG,
                            PNG, WEBP & HEIC</p>

                        <div class="flex justify-center">
                            <button id="open-camera"
                                class="gradient-bg px-6 py-4 rounded-2xl font-bold btn-hover flex items-center justify-center shadow-lg shadow-orange-500/20 mr-3">
                                <i class="fas fa-camera mr-2 text-xl"></i>Mở Camera
                            </button>
                            <button id="open-manual"
                                class="bg-[var(--input-bg)] border border-[var(--glass-border)] px-6 py-4 rounded-2xl font-bold btn-hover flex items-center justify-center hover:bg-white/10 transition-all">
                                <i class="fas fa-keyboard mr-2 text-xl opacity-60"></i>Nhập Thủ Công
                            </button>
                        </div>
                    </div>

                    <!-- Manual Input UI -->
                    <div id="manual-input-ui" class="hidden animate-fade-in text-left">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-xl font-bold">Nhập thông tin vé</h2>
                            <button onclick="hideManualInput(event)" class="text-[var(--text-muted)] hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)] ml-1">Đài/Tỉnh
                                    Thành</label>
                                <div class="relative group">
                                    <select id="manual-province"
                                        class="w-full bg-[var(--input-bg)] border border-[var(--glass-border)] rounded-2xl px-5 py-4 focus:outline-none focus:border-orange-500 appearance-none cursor-pointer transition-all hover:bg-white/5 text-[var(--text-main)]">
                                        <option value="">Chọn tỉnh thành...</option>
                                        <!-- Will be populated by JS -->
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-5 top-1/2 -translate-y-1/2 text-[var(--text-muted)] pointer-events-none group-hover:text-orange-500"></i>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)] ml-1">Ngày
                                    Mở Thưởng (DD/MM/YYYY)</label>
                                <input type="text" id="manual-date" placeholder="Ví dụ: 01/06/2026" maxlength="10"
                                    class="w-full bg-[var(--input-bg)] border border-[var(--glass-border)] rounded-2xl px-5 py-4 focus:outline-none focus:border-orange-500 transition-all text-[var(--text-main)]">
                            </div>
                            <div class="md:col-span-2 space-y-2">
                                <label
                                    class="text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)] ml-1">Số
                                    Dự Thưởng (6 chữ số)</label>
                                <input type="text" id="manual-number" maxlength="6" pattern="\d*"
                                    placeholder="Ví dụ: 123456"
                                    class="w-full bg-[var(--input-bg)] border border-[var(--glass-border)] rounded-3xl px-6 py-5 focus:outline-none focus:border-orange-500 transition-all text-4xl font-black tracking-[0.2em] text-center placeholder:text-white/10 [color-scheme:dark]">
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="hideManualInput(event)"
                                class="flex-grow bg-[var(--input-bg)] py-4 rounded-2xl font-bold hover:bg-white/10 transition-all uppercase tracking-widest text-xs border border-[var(--glass-border)]">
                                Quay Lại
                            </button>
                            <button onclick="submitManualInput()"
                                class="flex-[2] gradient-bg py-4 rounded-2xl font-bold btn-hover uppercase tracking-widest text-xs shadow-lg shadow-orange-500/20">
                                <i class="fas fa-search mr-2"></i>Dò Kết Quả
                            </button>
                        </div>
                    </div>

                    <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                </div>

                <!-- Processing & Results -->
                <div id="processing-view" class="hidden space-y-6 animate-fade-in">
                    <div class="premium-glass rounded-3xl p-6">
                        <img id="preview-img" src="" alt="Ticket" class="w-full rounded-2xl mb-6 shadow-2xl">

                        <div id="loading" class="flex flex-col items-center py-8">
                            <div class="loader mb-4"></div>
                            <h3 class="font-bold text-lg">Đang phân tích dữ liệu...</h3>
                            <p class="text-[var(--text-muted)] text-sm">AI đang nhận diện số và tỉnh thành
                            </p>
                        </div>

                        <div id="results-data" class="hidden space-y-8">
                            <!-- Win Status moved to top -->
                            <div id="win-status"></div>

                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold">Kết quả phân tích</h3>
                                <button id="edit-toggle-btn" onclick="toggleEditMode()"
                                    class="text-xs font-bold uppercase text-orange-400 hover:text-orange-300 transition-colors">
                                    <i class="fas fa-edit mr-1"></i>Chỉnh sửa
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="premium-glass p-4 rounded-2xl bg-[var(--input-bg)]">
                                    <p
                                        class="text-[var(--text-muted)] text-[10px] uppercase tracking-widest font-bold mb-1">
                                        Tỉnh
                                        Thành</p>
                                    <p id="res-province" class="text-orange-400 font-bold truncate outline-none">---
                                    </p>
                                </div>
                                <div class="premium-glass p-4 rounded-2xl bg-[var(--input-bg)]">
                                    <p
                                        class="text-[var(--text-muted)] text-[10px] uppercase tracking-widest font-bold mb-1">
                                        Ngày
                                        Mở</p>
                                    <p id="res-date" class="text-orange-400 font-bold outline-none">--/--/----</p>
                                </div>
                                <div class="col-span-2 premium-glass p-6 rounded-2xl text-center bg-[var(--input-bg)]">
                                    <p
                                        class="text-[var(--text-muted)] text-[10px] uppercase tracking-widest font-bold mb-2">
                                        Số
                                        Của Bạn</p>
                                    <p id="res-number"
                                        class="text-4xl md:text-5xl font-black tracking-[0.15em] md:tracking-[0.2em] text-[var(--text-main)] outline-none">
                                        ------
                                    </p>
                                </div>
                            </div>

                            <div id="results-table-container" class="hidden animate-fade-in">
                                <!-- Results table will be injected here -->
                            </div>

                            <div id="recheck-container" class="hidden animate-fade-in">
                                <button onclick="reCheckManual()"
                                    class="w-full gradient-bg py-4 rounded-2xl font-bold btn-hover uppercase tracking-widest text-sm shadow-lg shadow-orange-500/20">
                                    <i class="fas fa-sync-alt mr-2"></i>Lưu & Kiểm tra lại
                                </button>
                                <p class="text-center text-[10px] text-[var(--text-muted)] mt-2 italic">Dữ liệu sẽ
                                    được
                                    đối chiếu
                                    lại với nhà đài</p>
                            </div>

                            <button id="scan-new-btn" onclick="resetUI()"
                                class="w-full bg-[var(--input-bg)] hover:bg-[var(--input-bg)] py-4 rounded-2xl font-bold transition-all border border-[var(--glass-border)] uppercase tracking-widest text-sm">
                                <i class="fas fa-redo-alt mr-2 opacity-50"></i>Quét vé khác
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Error & Pending View -->
                <div id="error-section"
                    class="hidden premium-glass border-red-500/30 rounded-3xl p-8 text-center animate-fade-in shadow-2xl">
                    <!-- Error Icon -->
                    <div id="error-icon"
                        class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <!-- Pending Icon -->
                    <div id="pending-icon"
                        class="hidden w-16 h-16 bg-orange-500/10 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>

                    <h3 id="error-title" class="text-xl font-bold mb-2">Oops! Có lỗi rồi</h3>
                    <p id="error-msg" class="text-[var(--text-muted)] text-sm mb-6 leading-relaxed"></p>

                    <div class="flex justify-center">
                        <button id="error-action-btn" onclick="resetUI()"
                            class="px-10 py-3 bg-red-500/20 text-red-400 rounded-2xl hover:bg-red-500/30 transition-all font-bold min-w-[150px]">
                            Thử lại
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Right Side: History & Stats -->
        <div id="history-drawer-overlay" class="history-drawer-overlay lg:hidden" onclick="toggleMobileHistory()"></div>
        <div id="history-drawer"
            class="lg:col-span-1 space-y-6 history-drawer lg:translate-y-0 lg:static lg:block lg:bg-transparent lg:border-none lg:p-0 lg:shadow-none lg:max-h-full"
            style="animation-delay: 0.2s">
            <div class="mobile-handle lg:hidden"></div>
            <!-- Statistics Card -->
            <div id="stats-container"
                class="premium-glass rounded-3xl p-6 border-[var(--glass-border)] bg-gradient-to-br from-orange-500/5 to-pink-500/5">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-orange-500"></i>Thống kê & Tài chính
                </h3>
                <div class="grid grid-cols-1 gap-4">
                    <div
                        class="flex justify-between items-center p-3 rounded-xl bg-[var(--input-bg)] border border-[var(--glass-border)]">
                        <span class="text-xs text-[var(--text-muted)] font-bold uppercase tracking-wider">Tổng tiền
                            trúng</span>
                        <span id="stat-total-win" class="text-xl font-black text-green-400">0đ</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div
                            class="p-3 rounded-xl bg-[var(--input-bg)] border border-[var(--glass-border)] text-center">
                            <p class="text-[10px] text-[var(--text-muted)] font-bold uppercase mb-1">Đã quét</p>
                            <p id="stat-scanned" class="text-xl font-black">0</p>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-[var(--input-bg)] border border-[var(--glass-border)] text-center">
                            <p class="text-[10px] text-[var(--text-muted)] font-bold uppercase mb-1">Số lần trúng</p>
                            <p id="stat-lucky" class="text-xl font-black text-orange-400">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-bold flex items-center">
                    <i class="fas fa-history mr-2 text-[var(--text-muted)]"></i>Lịch sử quét
                </h3>
                <button onclick="clearHistory()"
                    class="text-[10px] uppercase font-bold text-[var(--text-muted)] hover:text-red-400 transition-colors">
                    Xóa tất cả
                </button>
            </div>

            <div id="history-list" class="space-y-4 max-h-[50vh] lg:max-h-[80vh] overflow-y-auto pr-2 custom-scrollbar">
                <!-- History items injected here -->
                <div class="text-center py-20 opacity-30 italic text-sm" id="empty-history">
                    Chưa có vé nào được quét
                </div>
            </div>
        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal items-center justify-center">
        <div
            class="premium-glass rounded-[2rem] p-8 w-full max-w-md m-4 border-[var(--glass-border)] relative shadow-2xl">
            <button id="close-settings" class="absolute top-6 right-6 text-[var(--text-muted)] hover:text-white">
                <i class="fas fa-times"></i>
            </button>

            <h3 class="text-2xl font-bold mb-6">Cài đặt</h3>

            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-[var(--text-muted)] mb-3">Giao
                        diện ứng
                        dụng</label>
                    <div class="relative group">
                        <select id="theme-select"
                            class="w-full bg-[var(--input-bg)] border border-[var(--glass-border)] rounded-2xl px-5 py-4 focus:outline-none focus:border-orange-500 appearance-none cursor-pointer transition-all hover:bg-[var(--input-bg)] text-[var(--text-main)]">
                            <option value="auto" class="bg-[var(--bg-main)] text-[var(--text-main)]">Mặc định hệ thống
                            </option>
                            <option value="light" class="bg-[var(--bg-main)] text-[var(--text-main)]">Giao diện sáng
                            </option>
                            <option value="dark" class="bg-[var(--bg-main)] text-[var(--text-main)]">Giao diện tối
                            </option>
                            <option value="gold" class="bg-[var(--bg-main)] text-[var(--text-main)]">Imperial Gold
                                (Premium)</option>
                            <option value="cyberpunk" class="bg-[var(--bg-main)] text-[var(--text-main)]">Cyberpunk Neon
                            </option>
                        </select>
                        <i
                            class="fas fa-chevron-down absolute right-5 top-1/2 -translate-y-1/2 text-[var(--text-muted)] pointer-events-none transition-transform group-hover:text-orange-500"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-[var(--text-muted)] mb-3">AI API
                        Key
                        (Cá nhân)</label>
                    <input type="password" id="api-key-input" placeholder="Dán API key tại đây..."
                        class="w-full bg-[var(--input-bg)] border border-[var(--glass-border)] rounded-2xl px-5 py-4 focus:outline-none focus:border-orange-500 transition-all text-[var(--text-main)]">
                </div>

                <div class="p-4 rounded-2xl bg-orange-500/10 border border-orange-500/20">
                    <div class="flex gap-3">
                        <i class="fas fa-shield-alt text-orange-500 mt-1"></i>
                        <div>
                            <p class="text-sm font-bold text-orange-200">Bảo mật của bạn</p>
                            <p class="text-[11px] text-orange-200/60 leading-relaxed mt-1">
                                Key được lưu duy nhất tại trình duyệt của bạn (LocalStorage).
                                Chúng tôi cam kết không lưu lại thông tin này trên server.
                            </p>
                        </div>
                    </div>
                </div>

                <button id="save-settings"
                    class="w-full gradient-bg py-4 rounded-2xl font-bold btn-hover uppercase tracking-widest text-sm">
                    Lưu cấu hình
                </button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="modal items-center justify-center">
        <canvas id="confetti-canvas" class="confetti-canvas"></canvas>
        <div
            class="modal-content-glass rounded-[2.5rem] p-6 md:p-12 w-full max-w-3xl m-4 border-[var(--glass-border)] relative shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar animate-fade-in">
            <div class="mobile-handle"></div>
            <button id="close-results"
                class="absolute top-4 right-4 md:top-8 md:right-8 text-[var(--text-muted)] hover:text-white z-10 p-2 transition-transform hover:scale-110">
                <i class="fas fa-times text-xl md:text-2xl"></i>
            </button>

            <div id="modal-win-container" class="hidden">
                <div class="text-center mb-6 md:mb-8">
                    <div class="inline-block p-3 rounded-full bg-yellow-500/10 mb-3 win-glow">
                        <i class="fas fa-trophy text-3xl md:text-4xl text-yellow-500/80"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold text-[var(--text-main)] mb-1 italic">CHÚC MỪNG BẠN!</h2>
                    <p class="text-[var(--text-muted)] uppercase tracking-[0.2em] text-[9px] md:text-[10px] font-bold">
                        Bạn đã
                        trúng giải</p>
                </div>

                <div id="modal-prize-display" class="flex flex-col gap-4 mb-10">
                    <!-- Winning prizes will be injected here with big typography -->
                </div>
            </div>

            <div id="modal-lose-container" class="hidden">
                <div class="text-center mb-8 md:mb-10">
                    <div class="inline-block p-4 rounded-full bg-slate-500/10 mb-4">
                        <i class="fas fa-heart text-4xl md:text-5xl text-pink-500/50"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold text-[var(--text-main)] mb-2">Hẹn Bạn Lần Sau</h2>
                    <p class="text-[var(--text-muted)] uppercase tracking-widest text-[10px] md:text-xs font-bold">Không
                        trúng
                        giải kỳ này</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10">
                <div
                    class="premium-glass p-5 rounded-3xl bg-[var(--input-bg)] border-[var(--glass-border)] flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center text-orange-500">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div>
                        <p class="text-[var(--text-muted)] text-[10px] uppercase font-bold tracking-tighter">Tỉnh Thành
                        </p>
                        <p id="modal-res-province" class="text-[var(--text-main)] font-bold text-lg">---</p>
                    </div>
                </div>
                <div
                    class="premium-glass p-5 rounded-3xl bg-[var(--input-bg)] border-[var(--glass-border)] flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div>
                        <p class="text-[var(--text-muted)] text-[10px] uppercase font-bold tracking-tighter">Ngày Mở
                            Thưởng</p>
                        <p id="modal-res-date" class="text-[var(--text-main)] font-bold text-lg">--/--/----</p>
                    </div>
                </div>
                <div
                    class="md:col-span-2 premium-glass p-5 md:p-6 rounded-2xl md:rounded-3xl text-center bg-[var(--input-bg)] border-[var(--glass-border)] relative overflow-hidden group">
                    <p class="text-[var(--text-muted)] text-[10px] uppercase font-bold tracking-[0.2em] mb-2">Số Của Bạn
                    </p>
                    <p id="modal-res-number"
                        class="text-3xl md:text-4xl font-black tracking-[0.1em] text-[var(--text-main)]">------
                    </p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h3 class="text-xs font-bold uppercase text-[var(--text-muted)] tracking-widest">Chi tiết kết quả
                        nhà đài</h3>
                    <div class="h-px bg-[var(--input-bg)] flex-grow ml-4"></div>
                </div>
                <div id="modal-results-table-container"></div>
            </div>

            <div class="mt-8 md:mt-12 flex flex-col sm:flex-row gap-3 md:gap-4">
                <button id="close-results-btn"
                    class="flex-grow bg-[var(--input-bg)] py-4 md:py-5 rounded-2xl md:rounded-[1.5rem] font-bold hover:bg-white/20 transition-all uppercase tracking-widest text-xs md:text-sm border border-[var(--glass-border)]">
                    <span>Đã hiểu</span>
                </button>
                <button id="share-win-btn" onclick="downloadWinImage()"
                    class="flex-grow gradient-bg py-4 md:py-5 rounded-2xl md:rounded-[1.5rem] font-bold btn-hover uppercase tracking-widest text-xs md:text-sm shadow-xl shadow-orange-500/20 flex items-center justify-center gap-2 hidden">
                    <i class="fas fa-share-alt"></i>
                    <span>Chia sẻ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-ui" class="camera-modal hidden">
        <div class="camera-wrapper">
            <div class="camera-video-container">
                <video id="video" autoplay playsinline></video>
                <div class="camera-guide-overlay"></div>
            </div>
            <div class="camera-controls-container">
                <div class="flex justify-center items-center gap-10 md:gap-14">
                    <button id="flip-camera"
                        class="w-14 h-14 rounded-full premium-glass text-white/40 hover:text-white transition-all flex items-center justify-center text-xl hover:bg-[var(--input-bg)]">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="capture-btn"
                        class="w-24 h-24 rounded-full border-4 border-[var(--glass-border)] p-1 group relative">
                        <div
                            class="w-full h-full bg-white rounded-full group-hover:scale-90 transition-transform flex items-center justify-center text-black shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                            <div class="w-16 h-16 rounded-full border border-black/10 flex items-center justify-center">
                                <i class="fas fa-camera text-2xl"></i>
                            </div>
                        </div>
                        <div class="absolute -inset-2 border border-[var(--glass-border)] rounded-full animate-pulse">
                        </div>
                    </button>
                    <button id="close-camera"
                        class="w-14 h-14 rounded-full premium-glass text-white/40 hover:text-red-400 transition-all flex items-center justify-center text-xl hover:bg-[var(--input-bg)]">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-center space-y-1">
                    <p class="text-orange-500/80 text-[10px] font-black uppercase tracking-[0.3em]">Smart Scanning
                        Active</p>
                    <p class="text-slate-600 text-[8px] uppercase tracking-widest font-bold">Giữ điện thoại ổn định để
                        kết quả chính xác nhất</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Theme Management ---
        const themeSelect = document.getElementById('theme-select');
        const themeColorMeta = document.querySelector('meta[name="theme-color"]');

        function applyTheme(theme) {
            const root = document.documentElement;
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            let targetTheme = theme;
            if (theme === 'auto') {
                targetTheme = systemDark ? 'dark' : 'light';
            }

            root.setAttribute('data-theme', targetTheme);

            // Update Meta Theme Color for mobile status bars
            const statusBarColor = getComputedStyle(root).getPropertyValue('--status-bar').trim();
            if (themeColorMeta) themeColorMeta.setAttribute('content', statusBarColor);

            // Update Apple status bar style
            const appleStatusMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
            if (appleStatusMeta) {
                appleStatusMeta.setAttribute('content', targetTheme === 'light' ? 'default' : 'black-translucent');
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('app_theme') || 'auto';
            if (themeSelect) {
                themeSelect.value = savedTheme;
                themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
            }
            applyTheme(savedTheme);
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (localStorage.getItem('app_theme') === 'auto' || !localStorage.getItem('app_theme')) {
                applyTheme('auto');
            }
        });

        // Immediate initialization to prevent flash
        initTheme();

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const video = document.getElementById('video');
        const cameraUI = document.getElementById('camera-ui');
        const uploadUI = document.getElementById('upload-ui');
        const processingView = document.getElementById('processing-view');
        const previewImg = document.getElementById('preview-img');
        const loading = document.getElementById('loading');
        const resultsData = document.getElementById('results-data');
        const errorSection = document.getElementById('error-section');
        const errorMsg = document.getElementById('error-msg');
        const historyList = document.getElementById('history-list');
        const emptyHistory = document.getElementById('empty-history');
        const resultsModal = document.getElementById('results-modal');

        const flipBtn = document.getElementById('flip-camera');
        let isMirrored = false;
        let videoTrack = null;
        let isEditMode = false;
        let isManualMode = false;
        let datePicker = null;

        // Initialize Premium Date Picker
        function initDatePicker() {
            datePicker = flatpickr("#manual-date", {
                locale: "vn",
                dateFormat: "d/m/Y",
                disableMobile: "true",
                theme: "dark",
                defaultDate: "today",
                monthSelectorType: "dropdown",
                allowInput: true, // Allow direct typing as a fallback
                onOpen: function (selectedDates, dateStr, instance) {
                    // Ensure the year input is properly visible when opened
                    setTimeout(() => {
                        const yearInput = instance.calendarContainer.querySelector('.cur-year');
                        if (yearInput) yearInput.style.display = 'inline-block';
                    }, 10);
                }
            });
        }
        initDatePicker();

        // Populate Province Select for Manual Input
        function populateProvinces() {
            const select = document.getElementById('manual-province');
            if (!select) return;

            // Simple grouped list from PROVINCE_MAP keys
            const provinces = [
                "TP.HCM", "An Giang", "Bạc Liêu", "Bến Tre", "Bình Dương", "Bình Phước", "Bình Thuận", "Cà Mau", "Cần Thơ", "Đà Lạt",
                "Đồng Nai", "Đồng Tháp", "Hậu Giang", "Kiên Giang", "Long An", "Sóc Trăng", "Tây Ninh", "Tiền Giang", "Trà Vinh", "Vĩnh Long", "Vũng Tàu",
                "Đà Nẵng", "Đắk Lắk", "Đắk Nông", "Gia Lai", "Khánh Hòa", "Kon Tum", "Ninh Thuận", "Phú Yên", "Quảng Bình", "Quảng Nam", "Quảng Ngãi", "Quảng Trị", "Thừa Thiên Huế",
                "Miền Bắc"
            ];

            provinces.sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                opt.className = "bg-[var(--bg-main)] text-[var(--text-main)]";
                select.appendChild(opt);
            });
        }
        populateProvinces();

        // --- Manual Input Mode ---
        function showManualInput(e) {
            if (e) e.stopPropagation();
            isManualMode = true;
            uploadUI.classList.add('hidden');
            document.getElementById('manual-input-ui').classList.remove('hidden');

            // Auto-set today's date in DD/MM/YYYY
            const now = new Date();
            const d = String(now.getDate()).padStart(2, '0');
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const y = now.getFullYear();
            document.getElementById('manual-date').value = `${d}/${m}/${y}`;
        }

        // Auto-format DD/MM/YYYY as user types
        document.getElementById('manual-date').addEventListener('input', function (e) {
            let v = e.target.value.replace(/\D/g, '').slice(0, 8);
            if (v.length >= 5) {
                v = v.slice(0, 2) + '/' + v.slice(2, 4) + '/' + v.slice(4);
            } else if (v.length >= 3) {
                v = v.slice(0, 2) + '/' + v.slice(2);
            }
            e.target.value = v;
        });

        function hideManualInput(e) {
            if (e) e.stopPropagation();
            isManualMode = false;
            document.getElementById('manual-input-ui').classList.add('hidden');
            uploadUI.classList.remove('hidden');
        }

        async function submitManualInput() {
            const province = document.getElementById('manual-province').value;
            const date = document.getElementById('manual-date').value.trim();
            const number = document.getElementById('manual-number').value.trim();

            if (!province || !date || !number) {
                alert('Vui lòng nhập đầy đủ thông tin: Tỉnh thành, Ngày và Số dự thưởng.');
                return;
            }

            if (number.length !== 6 || isNaN(number)) {
                alert('Số dự thưởng phải là 6 chữ số (ví dụ: 123456).');
                return;
            }

            const manualInfo = { province, date, number };
            const apiKey = localStorage.getItem('gemini_api_key');

            // Switch to loading UI
            hideManualInput();
            dropZone.classList.add('hidden');
            processingView.classList.remove('hidden');
            previewImg.classList.add('hidden'); // No image for manual input
            loading.classList.remove('hidden');
            resultsData.classList.add('hidden');

            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ manualInfo, apiKey })
                });

                const data = await response.json();
                loading.classList.add('hidden');

                if (data.results && data.results[0]) {
                    const res = data.results[0];
                    if (res.status === 'OK') {
                        currentBatch = [res];
                        currentIndex = 0;
                        showResults(res, true);
                        saveToHistory(res);
                    } else {
                        showError(res.message || 'Không tìm thấy kết quả.');
                    }
                } else {
                    showError(data.error || 'Lỗi xử lý');
                }
            } catch (err) {
                loading.classList.add('hidden');
                showError('Kết nối server thất bại: ' + err.message);
            }
        }

        function formatProvinceName(name) {
            if (!name) return '---';
            let cleanName = name.trim().replace(/tp\.\s*/gi, '');
            return cleanName.toLowerCase().split(/\s+/).filter(w => w).map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        // --- History Logic ---
        function saveToHistory(data) {
            let history = JSON.parse(localStorage.getItem('lottery_history') || '[]');
            const newItem = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('vi-VN'),
                info: data.info,
                isWin: data.win_details && data.win_details.length > 0,
                win_details: data.win_details
                // results: data.results <-- Removed to save space
            };
            history.unshift(newItem);
            history = history.slice(0, 50); // Keep last 50
            localStorage.setItem('lottery_history', JSON.stringify(history));
            renderHistory();
            renderStatistics();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('lottery_history') || '[]');
            if (history.length === 0) {
                emptyHistory.style.display = 'block';
                historyList.innerHTML = '';
                return;
            }
            emptyHistory.style.display = 'none';

            historyList.innerHTML = history.map(item => `
                <div class="premium-glass p-4 rounded-2xl history-card cursor-pointer bg-[var(--input-bg)] border-[var(--glass-border)]" onclick="reShow(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-[var(--text-muted)]">${item.timestamp}</span>
                        ${item.isWin ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-[9px] font-bold rounded uppercase">Trúng giải</span>' : ''}
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm text-[var(--text-main)]">${formatProvinceName(item.info.province)}</p>
                            <p class="text-xs text-[var(--text-muted)]">${item.info.date}</p>
                        </div>
                        <p class="text-lg font-black tracking-widest ${item.isWin ? 'text-green-400' : 'text-[var(--text-main)]'}">${item.info.number}</p>
                    </div>
                </div>
            `).join('');
        }

        function reShow(item) {
            resetUI();
            dropZone.classList.add('hidden');
            processingView.classList.remove('hidden');
            previewImg.classList.add('hidden'); // Hide preview for history recall
            loading.classList.add('hidden');

            // Set as current batch of 1 for navigation/history context
            currentBatch = [item];
            currentIndex = 0;

            renderNavigation(); // Ensure nav is hidden/updated for single item
            showResults(item, true); // showResults will handle history pushing and auto-opening modal
        }

        function clearHistory() {
            if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử?')) {
                localStorage.removeItem('lottery_history');
                renderHistory();
                renderStatistics();
            }
        }

        // --- Manual Edit Logic ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const fields = ['res-province', 'res-date', 'res-number'];
            const btn = document.getElementById('edit-toggle-btn');
            const recheckContainer = document.getElementById('recheck-container');
            const scanNewBtn = document.getElementById('scan-new-btn');

            fields.forEach(id => {
                const el = document.getElementById(id);
                el.contentEditable = isEditMode;
                if (isEditMode) {
                    el.classList.add('bg-[var(--input-bg)]', 'rounded', 'px-2', 'py-1', 'border', 'border-[var(--glass-border)]');
                } else {
                    el.classList.remove('bg-[var(--input-bg)]', 'rounded', 'px-2', 'py-1', 'border', 'border-[var(--glass-border)]');
                }
            });

            if (isEditMode) {
                btn.innerHTML = '<i class="fas fa-times mr-1"></i>Hủy';
                btn.classList.replace('text-orange-400', 'text-red-400');
                recheckContainer.classList.remove('hidden');
                scanNewBtn.classList.add('hidden');
            } else {
                btn.innerHTML = '<i class="fas fa-edit mr-1"></i>Chỉnh sửa';
                btn.classList.replace('text-red-400', 'text-orange-400');
                recheckContainer.classList.add('hidden');
                scanNewBtn.classList.remove('hidden');
            }
        }

        async function reCheckManual() {
            const province = document.getElementById('res-province').textContent.trim();
            const date = document.getElementById('res-date').textContent.trim();
            const number = document.getElementById('res-number').textContent.trim();

            if (isEditMode) toggleEditMode(); // Turn off edit mode

            resultsData.classList.add('hidden');
            loading.classList.remove('hidden');
            document.getElementById('win-status').innerHTML = '';

            const apiKey = localStorage.getItem('gemini_api_key');

            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey,
                        manualInfo: { province, date, number }
                    })
                });

                if (response.status === 202) {
                    const data = await response.json();
                    loading.classList.add('hidden');
                    showPendingMessage(data.message);
                    return;
                }

                const data = await response.json();
                loading.classList.add('hidden');

                if (data.success) {
                    showResults(data);
                    // We don't necessarily save to history here to avoid duplicates if it was a minor fix, 
                    // but the user might want the corrected version in history. 
                    // Let's save it, history logic handles deduplication if needed (by timestamp usually, but here by ID)
                    saveToHistory(data);
                } else {
                    showError(data.error || 'Lỗi xử lý');
                    // Briefly show results back so user can correct again if needed
                    resultsData.classList.remove('hidden');
                }
            } catch (err) {
                loading.classList.add('hidden');
                showError('Kết nối server thất bại: ' + err.message);
                resultsData.classList.remove('hidden');
            }
        }

        // --- Camera Logic ---
        document.getElementById('open-camera').addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!navigator.mediaDevices?.getUserMedia) return alert('Trình duyệt không hỗ trợ camera');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];
                openModal(cameraUI);
            } catch (err) {
                alert('Lỗi camera: ' + err.message);
            }
        });

        // Toggle Manual Input
        document.getElementById('open-manual').addEventListener('click', (e) => {
            e.stopPropagation();
            showManualInput();
        });

        document.getElementById('close-camera').addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal(cameraUI);
        });

        flipBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            isMirrored = !isMirrored;
            video.classList.toggle('mirror', isMirrored);
        });

        function stopCamera() {
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            videoTrack = null;
            cameraUI.classList.add('hidden');
            cameraUI.style.display = 'none';
        }

        document.getElementById('capture-btn').addEventListener('click', (e) => {
            e.stopPropagation();

            // 1. Get video natural and display dimensions
            const vWidth = video.videoWidth;
            const vHeight = video.videoHeight;
            const dWidth = video.offsetWidth;
            const dHeight = video.offsetHeight;

            // 2. Calculate aspect ratios
            const vRatio = vWidth / vHeight;
            const dRatio = dWidth / dHeight;

            let sx, sy, sWidth, sHeight;

            // 3. Simulating 'object-cover' cropping math
            if (vRatio > dRatio) {
                // Source is wider than display: Height matches, width is cropped from sides
                sHeight = vHeight;
                sWidth = vHeight * dRatio;
                sx = (vWidth - sWidth) / 2;
                sy = 0;
            } else {
                // Source is taller than display: Width matches, height is cropped from top/bottom
                sWidth = vWidth;
                sHeight = vWidth / dRatio;
                sx = 0;
                sy = (vHeight - sHeight) / 2;
            }

            // 4. Create canvas with cropped dimensions
            const canvas = document.createElement('canvas');
            canvas.width = sWidth;
            canvas.height = sHeight;
            const ctx = canvas.getContext('2d');

            // 5. Handle mirroring if active
            if (isMirrored) {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
            }

            // 6. Draw the specific visible region (sWidth x sHeight) from (sx, sy)
            ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);

            const dataUrl = canvas.toDataURL('image/png');
            playSound('shutter');
            stopCamera();
            processImages([dataUrl]);
        });

        // --- File Upload Logic ---
        dropZone.addEventListener('click', (e) => {
            // Prevent if in manual mode or if clicking buttons (though propagation should stop them)
            if (isManualMode) return;
            if (e.target.closest('button')) return;

            fileInput.click();
        });
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (isManualMode) return;
            dropZone.classList.add('scale-[1.02]', 'border-orange-500');
        });
        dropZone.addEventListener('dragleave', () => {
            if (isManualMode) return;
            dropZone.classList.remove('scale-[1.02]', 'border-orange-500');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            if (isManualMode) return;
            dropZone.classList.remove('scale-[1.02]', 'border-orange-500');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            if (isManualMode) return;
            const files = Array.from(e.target.files);
            if (files.length > 0) handleFiles(files);
        });

        // --- Clipboard (Paste) Support ---
        window.addEventListener('paste', (e) => {
            if (isManualMode) return;
            const items = e.clipboardData.items;
            const files = [];
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    if (blob) files.push(blob);
                }
            }
            if (files.length > 0) {
                // UI Feedback
                dropZone.classList.add('border-orange-500', 'bg-orange-500/10', 'scale-[1.02]');
                setTimeout(() => {
                    dropZone.classList.remove('border-orange-500', 'bg-orange-500/10', 'scale-[1.02]');
                }, 500);

                handleFiles(files);
            }
        });

        async function handleFiles(files) {
            const dataUrls = [];
            for (const file of files) {
                const url = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                dataUrls.push(url);
            }
            processImages(dataUrls);
        }

        function resetUI() {
            processingView.classList.add('hidden');
            errorSection.classList.add('hidden');
            dropZone.classList.remove('hidden');
            uploadUI.classList.remove('hidden');
            resultsData.classList.add('hidden');
            loading.classList.remove('hidden');
            previewImg.classList.remove('hidden');
            document.getElementById('results-table-container').classList.add('hidden');
            resultsModal.style.display = 'none';
            cameraUI.classList.add('hidden');
            cameraUI.style.display = 'none';
            fileInput.value = ''; // Fix: allow re-uploading same file after error

            // Hide batch navigation
            const nav = document.getElementById('batch-nav');
            if (nav) nav.classList.add('hidden');

            // Close mobile history if open
            const drawer = document.getElementById('history-drawer');
            const overlay = document.getElementById('history-drawer-overlay');
            if (drawer) drawer.classList.remove('open');
            if (overlay) overlay.classList.remove('visible');
        }

        let currentBatch = [];
        let currentIndex = 0;
        let batchErrors = [];

        async function processImages(dataUrls) {
            resetUI();
            if (dataUrls.length === 0) return;

            dropZone.classList.add('hidden');
            processingView.classList.remove('hidden');
            previewImg.src = dataUrls[0]; // Preview first image

            const apiKey = localStorage.getItem('gemini_api_key');
            currentBatch = [];
            currentIndex = 0;
            batchErrors = [];

            for (let i = 0; i < dataUrls.length; i++) {
                if (dataUrls.length > 1) {
                    loading.querySelector('p').textContent = `Đang xử lý ảnh ${i + 1}/${dataUrls.length}...`;
                    previewImg.src = dataUrls[i]; // Update preview as we go
                }

                try {
                    const response = await fetch('/check', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: dataUrls[i], apiKey })
                    });

                    const data = await response.json();

                    if (data.results && Array.isArray(data.results)) {
                        data.results.forEach(res => {
                            if (res.status === 'OK') {
                                res.imageUrl = dataUrls[i]; // Store image for navigation sync
                                currentBatch.push(res);
                                saveToHistory(res);
                            } else {
                                // Collect errors/not_ready for summary
                                batchErrors.push(res);
                                if (res.status === 'NOT_READY') {
                                    saveToHistory(res); // Still save NOT_READY to history
                                }
                            }
                        });
                    } else if (data.error) {
                        batchErrors.push({ status: 'ERROR', message: data.error });
                    }
                } catch (err) {
                    console.error("Lỗi xử lý ảnh:", err);
                    batchErrors.push({ status: 'ERROR', message: 'Kết nối mạng thất bại' });
                }
            }

            loading.classList.add('hidden');
            loading.querySelector('p').textContent = 'AI đang nhận diện số và tỉnh thành'; // Reset text

            if (currentBatch.length > 0) {
                showBatchResults();
                if (batchErrors.length > 0) {
                    showBatchSummaryNotification();
                }
            } else {
                // If all failed, show the primary error screen with a consolidated message
                const errorMsgText = batchErrors.length > 1
                    ? `Đã quét xong ${dataUrls.length} ảnh nhưng không thể nhận diện được vé số nào hợp lệ.`
                    : (batchErrors[0]?.message || 'Không thể nhận diện vé số.');
                showError(errorMsgText);
            }
        }

        function showBatchSummaryNotification() {
            // Create a temporary toast/notification for batch errors
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 z-[2000] premium-glass px-6 py-4 rounded-2xl border-orange-500/30 text-orange-400 font-bold shadow-2xl animate-fade-in flex items-center gap-3 backdrop-blur-xl';
            notification.innerHTML = `
                <i class="fas fa-info-circle"></i>
                <span>Phát hiện ${batchErrors.length} vé có lỗi hoặc chưa có kết quả.</span>
                <button onclick="this.parentElement.remove()" class="ml-2 opacity-50 hover:opacity-100"><i class="fas fa-times"></i></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => { if (notification.parentNode) notification.remove(); }, 6000);
        }

        function showBatchResults() {
            if (!currentBatch || currentBatch.length === 0) return;

            const data = currentBatch[currentIndex];

            // Sync image with current ticket
            if (data.imageUrl) {
                previewImg.src = data.imageUrl;
                previewImg.classList.remove('hidden');
            }

            showResults(data, false); // No auto-open in batch mode

            // Update navigation UI
            renderNavigation();
        }

        function renderNavigation() {
            let navContainer = document.getElementById('batch-nav');
            if (!navContainer) {
                navContainer = document.createElement('div');
                navContainer.id = 'batch-nav';
                navContainer.className = 'flex justify-center items-center gap-4 mt-6';
                resultsData.parentNode.insertBefore(navContainer, resultsData);
            }

            if (currentBatch.length <= 1) {
                navContainer.classList.add('hidden');
                return;
            }

            navContainer.classList.remove('hidden');
            navContainer.innerHTML = `
                <button onclick="prevTicket()" class="w-10 h-10 rounded-full premium-glass flex items-center justify-center text-[var(--text-muted)] hover:text-white transition-all ${currentIndex === 0 ? 'opacity-30 pointer-events-none' : ''}">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="flex gap-2">
                    ${currentBatch.map((_, i) => `<div class="w-2 h-2 rounded-full transition-all ${i === currentIndex ? 'bg-orange-500 w-6' : 'bg-white/20'}"></div>`).join('')}
                </div>
                <button onclick="nextTicket()" class="w-10 h-10 rounded-full premium-glass flex items-center justify-center text-[var(--text-muted)] hover:text-white transition-all ${currentIndex === currentBatch.length - 1 ? 'opacity-30 pointer-events-none' : ''}">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
        }

        function nextTicket() {
            if (currentIndex < currentBatch.length - 1) {
                currentIndex++;
                showBatchResults();
            }
        }

        function prevTicket() {
            if (currentIndex > 0) {
                currentIndex--;
                showBatchResults();
            }
        }

        function showResults(data, autoOpen = false) {
            // Push RESULTS_STATE if we are in the base/home state (null)
            if (window.history.state === null) {
                window.history.pushState(RESULTS_STATE, '');
            }

            // Reset edit mode if it was on
            if (isEditMode) toggleEditMode();

            // Clear any previous error/pending state if we are showing a success result
            errorSection.classList.add('hidden');
            resultsData.classList.remove('hidden');

            // Main UI
            document.getElementById('res-province').textContent = formatProvinceName(data.info.province);
            document.getElementById('res-date').textContent = data.info.date;
            document.getElementById('res-number').textContent = data.info.number;

            // Modal UI
            document.getElementById('modal-res-province').textContent = formatProvinceName(data.info.province);
            document.getElementById('modal-res-date').textContent = data.info.date;
            document.getElementById('modal-res-number').textContent = data.info.number;
            renderResultsTable(data.results, 'results-table-container');
            renderResultsTable(data.results, 'modal-results-table-container');

            const winStatus = document.getElementById('win-status');
            const modalWinContainer = document.getElementById('modal-win-container');
            const modalLoseContainer = document.getElementById('modal-lose-container');
            const modalPrizeDisplay = document.getElementById('modal-prize-display');

            let winHtml = '';
            let modalPrizeHtml = '';
            const isWin = data.win_details && data.win_details.length > 0;

            if (isWin) {
                modalWinContainer.classList.remove('hidden');
                modalLoseContainer.classList.add('hidden');
                document.getElementById('share-win-btn').classList.remove('hidden');

                const maxPrize = Math.max(...data.win_details.map(d => d.value));

                data.win_details.forEach(detail => {
                    const val = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(detail.value);
                    const isBigWin = detail.value >= 10000000; // Big win if >= 10M

                    // Main UI HTML
                    winHtml += `
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-2xl text-center shadow-lg mb-4">
                            <i class="fas fa-trophy text-3xl mb-2 block"></i>
                            <h4 class="font-extrabold text-xl uppercase">${detail.name}</h4>
                            <p class="text-3xl font-black mt-1 text-white">${val}</p>
                        </div>
                    `;

                    // Modal UI HTML (Xịn xò)
                    modalPrizeHtml += `
                        <div class="premium-glass p-6 md:p-8 rounded-[2rem] bg-gradient-to-br from-green-500/20 to-emerald-500/5 border-green-500/30 text-center relative overflow-hidden shadow-2xl flex flex-col items-center justify-center min-h-[160px] md:min-h-[200px]">
                            <div class="prize-badge mb-4 md:mb-6 ${detail.name.includes('Đặc Biệt') ? 'gold-glow' : 'silver-glow'}">
                                <i class="fas fa-star text-[10px]"></i>
                                <span class="text-[10px] md:text-[12px] opacity-80">${detail.name}</span>
                            </div>
                            <p class="text-3xl md:text-5xl lg:text-7xl font-black text-[var(--text-main)] win-glow mb-2 md:mb-4 tracking-tight uppercase leading-none break-words w-full">${val}</p>
                            ${isBigWin ? '<p class="text-green-500 text-[10px] md:text-[12px] font-bold uppercase tracking-[0.2em] mt-2 animate-pulse">JACKPOT WINNER!</p>' : ''}
                        </div>
                    `;
                });
                modalPrizeDisplay.innerHTML = modalPrizeHtml;
                startConfetti();

                // Enhanced Sound & Haptic based on prize
                if (maxPrize >= 10000000) playSound('big_win');
                else playSound('small_win');

            } else {
                modalWinContainer.classList.add('hidden');
                modalLoseContainer.classList.remove('hidden');
                document.getElementById('share-win-btn').classList.add('hidden');

                winHtml = `
                        <div class="premium-glass p-6 rounded-2xl text-center border-[var(--glass-border)] bg-[var(--input-bg)]">
                            <i class="fas fa-heart text-pink-500 mb-2 block"></i>
                            <p class="font-bold text-[var(--text-muted)]">Không trúng giải - Chúc bạn may mắn lần sau!</p>
                        </div>
                    `;
                playSound('no_win');
            }

            winStatus.innerHTML = winHtml;

            // Only auto-open modal if explicitly requested (history) or ONLY one ticket in batch
            if (autoOpen || (currentBatch && currentBatch.length === 1)) {
                openModal(resultsModal);
            }
        }

        // Simple Confetti
        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            const colors = ['#ff5e3a', '#ff2a6d', '#fbbf24', '#34d399', '#60a5fa'];

            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 8 + 4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 5 + 2,
                    angle: Math.random() * 6.28
                });
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.y += p.speed;
                    p.x += Math.sin(p.angle) * 1.5;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size / 2, 0, 6.28);
                    ctx.fill();

                    if (p.y > canvas.height) particles[i].y = -10;
                });
                if (resultsModal.style.display === 'flex') requestAnimationFrame(draw);
            }
            draw();
        }

        let audioCtx;

        function playSound(type) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();

                const playNote = (freq, start, duration, vol = 0.1, wave = 'sine') => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = wave;
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.setValueAtTime(freq, start);
                    gain.gain.setValueAtTime(0, start);
                    gain.gain.linearRampToValueAtTime(vol, start + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, start + duration);
                    osc.start(start);
                    osc.stop(start + duration);
                };

                const now = audioCtx.currentTime;

                switch (type) {
                    case 'small_win':
                        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                        playNote(523.25, now, 0.4, 0.1, 'triangle'); // C5
                        playNote(659.25, now + 0.1, 0.4, 0.1, 'triangle'); // E5
                        playNote(783.99, now + 0.2, 0.4, 0.1, 'triangle'); // G5
                        playNote(1046.50, now + 0.3, 0.6, 0.15, 'sine'); // C6
                        break;
                    case 'big_win':
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
                        // Fanfare chords
                        [523.25, 659.25, 783.99].forEach(f => playNote(f, now, 0.8, 0.1, 'square'));
                        [659.25, 830.61, 1046.50].forEach(f => playNote(f, now + 0.3, 0.8, 0.1, 'square'));
                        [783.99, 987.77, 1318.51].forEach(f => playNote(f, now + 0.6, 1.2, 0.2, 'sine'));
                        break;
                    case 'no_win':
                        playNote(392.00, now, 0.15, 0.05, 'sine'); // G4
                        playNote(329.63, now + 0.1, 0.2, 0.05, 'sine'); // E4
                        break;
                    case 'shutter':
                        // Noise-like sound for shutter
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(1000, now);
                        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                        gain.gain.setValueAtTime(0.2, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.1);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start(now);
                        osc.stop(now + 0.1);
                        break;
                }
            } catch (e) {
                console.log('Audio Error:', e);
            }
        }

        async function downloadWinImage() {
            const data = currentBatch[currentIndex];
            if (!data || !data.win_details || data.win_details.length === 0) return;

            const detail = data.win_details[0]; // Primary prize
            const valNum = detail.value;
            const valStr = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(valNum);

            // Determine Tier
            let theme = {
                id: 'standard',
                primary: '#ff5e3a',
                accent: '#ff2a6d',
                bgStart: '#1a1b26',
                bgEnd: '#0a0b14',
                cardBg: 'rgba(255, 255, 255, 0.08)',
                glow: 'rgba(255, 94, 58, 0.15)',
                text: '#ffffff',
                badgeText: '#ff5e3a'
            };

            if (valNum >= 500000000) { // Grand Tier (>= 500M)
                theme = {
                    id: 'grand',
                    primary: '#fbbf24', // Gold
                    accent: '#f59e0b',
                    bgStart: '#1e1b10', // Dark Gold/Earth
                    bgEnd: '#0a0904',
                    cardBg: 'rgba(251, 191, 36, 0.1)',
                    glow: 'rgba(251, 191, 36, 0.2)',
                    text: '#fbbf24',
                    badgeText: '#000000'
                };
            } else if (valNum >= 10000000) { // Major Tier (>= 10M)
                theme = {
                    id: 'major',
                    primary: '#e2e8f0', // Bright Silver
                    accent: '#94a3b8',
                    bgStart: '#0f172a', // Deeper Blue-Black
                    bgEnd: '#020617',
                    cardBg: 'rgba(255, 255, 255, 0.12)',
                    glow: 'rgba(255, 255, 255, 0.1)',
                    text: '#ffffff',
                    badgeText: '#0f172a'
                };
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200;
            canvas.height = 630;

            // 1. Background
            const baseGrad = ctx.createRadialGradient(600, 315, 0, 600, 315, 800);
            baseGrad.addColorStop(0, theme.bgStart);
            baseGrad.addColorStop(1, theme.bgEnd);
            ctx.fillStyle = baseGrad;
            ctx.fillRect(0, 0, 1200, 630);

            // 2. Ambient Lights
            const drawGlow = (x, y, radius, color) => {
                const grad = ctx.createRadialGradient(x, y, 0, x, y, radius);
                grad.addColorStop(0, color);
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.globalCompositeOperation = 'screen';
                ctx.fillRect(x - radius, y - radius, radius * 2, radius * 2);
                ctx.globalCompositeOperation = 'source-over';
            };
            drawGlow(0, 0, 400, theme.glow);
            drawGlow(1200, 630, 500, theme.glow);

            // 2.5 Background Watermark
            ctx.save();
            ctx.globalAlpha = theme.id === 'grand' ? 0.08 : 0.05;
            ctx.font = '280px Be Vietnam Pro, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillStyle = theme.primary;
            ctx.fillText('🏆', 600, 420);

            // Tier Specific Effects
            if (theme.id === 'grand' || theme.id === 'major') {
                const drawStar = (x, y, radius, color) => {
                    ctx.save();
                    ctx.beginPath();
                    ctx.translate(x, y);
                    ctx.moveTo(0, 0 - radius);
                    for (let i = 0; i < 5; i++) {
                        ctx.rotate(Math.PI / 5);
                        ctx.lineTo(0, 0 - (radius * 0.4));
                        ctx.rotate(Math.PI / 5);
                        ctx.lineTo(0, 0 - radius);
                    }
                    ctx.fillStyle = color;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = color;
                    ctx.fill();
                    ctx.restore();
                };

                const starCount = theme.id === 'grand' ? 60 : 40;
                for (let i = 0; i < starCount; i++) {
                    const x = Math.random() * 1200;
                    const y = Math.random() * 630;
                    const size = Math.random() * (theme.id === 'grand' ? 8 : 6) + 2;
                    ctx.globalAlpha = Math.random() * 0.4 + 0.1;

                    if (Math.random() > 0.7) {
                        drawStar(x, y, size, theme.primary);
                    } else {
                        ctx.beginPath();
                        ctx.arc(x, y, size / 3, 0, Math.PI * 2);
                        ctx.fillStyle = theme.primary;
                        ctx.fill();
                    }
                }

                if (theme.id === 'major') {
                    // Add Diagonal Beams for Major
                    ctx.save();
                    ctx.globalCompositeOperation = 'screen';
                    for (let i = 0; i < 3; i++) {
                        const grad = ctx.createLinearGradient(0, 0, 1200, 630);
                        grad.addColorStop(0, 'transparent');
                        grad.addColorStop(Math.random() * 0.5 + 0.2, 'rgba(255, 255, 255, 0.05)');
                        grad.addColorStop(1, 'transparent');
                        ctx.fillStyle = grad;
                        ctx.rotate((Math.random() - 0.5) * 0.1);
                        ctx.fillRect(0, -1000, 2000, 2000);
                    }
                    ctx.restore();
                }
            }
            ctx.restore();

            // 3. Central Glass Card
            const cardWidth = 1000;
            const cardHeight = 450;
            const cardX = (1200 - cardWidth) / 2;
            const cardY = (630 - cardHeight) / 2 + 20;
            const radius = 40;

            // Card Shadow
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 40;
            ctx.shadowOffsetY = 20;

            // Card Shape & Fill
            ctx.beginPath();
            ctx.roundRect ? ctx.roundRect(cardX, cardY, cardWidth, cardHeight, radius) : ctx.rect(cardX, cardY, cardWidth, cardHeight);

            const cardGrad = ctx.createLinearGradient(cardX, cardY, cardX + cardWidth, cardY + cardHeight);
            cardGrad.addColorStop(0, theme.cardBg);
            cardGrad.addColorStop(1, 'rgba(255, 255, 255, 0.02)');
            ctx.fillStyle = cardGrad;
            ctx.fill();

            // Card Border
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
            const borderGrad = ctx.createLinearGradient(cardX, cardY, cardX + cardWidth, cardY + cardHeight);
            borderGrad.addColorStop(0, 'rgba(255, 255, 255, 0.2)');
            borderGrad.addColorStop(1, 'rgba(255, 255, 255, 0.05)');
            ctx.strokeStyle = borderGrad;
            ctx.lineWidth = 2;
            ctx.stroke();

            // 4. Header Section
            const logoGrad = ctx.createLinearGradient(540, 0, 660, 0);
            logoGrad.addColorStop(0, theme.primary);
            logoGrad.addColorStop(1, theme.accent || theme.primary);
            ctx.fillStyle = logoGrad;
            ctx.font = '800 32px Be Vietnam Pro, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('DÒ VÉ SỐ AI', 600, 60);

            ctx.font = '700 12px Be Vietnam Pro, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.fillText('OFFICIAL VERIFIED RESULT', 600, 85);

            // 5. Winning Content
            const prizeLabel = detail.name.toUpperCase();

            // Prize Name Badge
            ctx.font = '800 18px Be Vietnam Pro, sans-serif';
            const textWidth = ctx.measureText(prizeLabel).width;
            const badgeW = textWidth + 40;
            const badgeH = 34;
            const badgeX = 600 - badgeW / 2;
            const badgeY = cardY + 60;

            ctx.fillStyle = theme.id === 'major' ? theme.id === 'major' ? '#cbd5e1' : theme.primary : theme.primary; // Overridden for major badge text if needed
            if (theme.id === 'major') {
                ctx.fillStyle = '#0f172a'; // Contrast text for silver badge
                const silverBadgeGrad = ctx.createLinearGradient(badgeX, badgeY, badgeX + badgeW, badgeY + badgeH);
                silverBadgeGrad.addColorStop(0, '#f8fafc');
                silverBadgeGrad.addColorStop(0.5, '#cbd5e1');
                silverBadgeGrad.addColorStop(1, '#94a3b8');
                ctx.save();
                ctx.fillStyle = silverBadgeGrad;
                ctx.beginPath();
                ctx.roundRect ? ctx.roundRect(badgeX, badgeY, badgeW, badgeH, 17) : ctx.rect(badgeX, badgeY, badgeW, badgeH);
                ctx.fill();
                ctx.restore();
                ctx.fillStyle = '#0f172a';
            } else {
                ctx.fillStyle = theme.id === 'grand' ? theme.primary : 'rgba(255, 255, 255, 0.1)';
                ctx.beginPath();
                ctx.roundRect ? ctx.roundRect(badgeX, badgeY, badgeW, badgeH, 17) : ctx.rect(badgeX, badgeY, badgeW, badgeH);
                ctx.fill();
                ctx.fillStyle = theme.badgeText;
            }

            ctx.fillText(prizeLabel, 600, badgeY + 23);

            // The BIG Number
            ctx.shadowColor = theme.id === 'grand' ? 'rgba(251, 191, 36, 0.6)' : theme.id === 'major' ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 94, 58, 0.5)';
            ctx.shadowBlur = 40;
            ctx.fillStyle = theme.text;
            ctx.font = '900 110px Be Vietnam Pro, sans-serif';
            ctx.fillText(valStr, 600, cardY + 220);
            ctx.shadowBlur = 0;

            // Congratulation Text
            ctx.font = '600 24px Be Vietnam Pro, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fillText('CHÚC MỪNG BẠN ĐÃ TRÚNG GIẢI!', 600, cardY + 280);

            // 6. Footer Details
            const infoY = cardY + 360;
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.moveTo(cardX + 100, infoY - 20);
            ctx.lineTo(cardX + cardWidth - 100, infoY - 20);
            ctx.stroke();

            const drawInfo = (label, value, x) => {
                ctx.textAlign = 'center';
                ctx.font = '800 12px Be Vietnam Pro, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.fillText(label, x, infoY);
                ctx.font = '700 24px Be Vietnam Pro, sans-serif';
                ctx.fillStyle = '#ffffff';
                ctx.fillText(value, x, infoY + 35);
            };

            drawInfo('SỐ VÉ', data.info.number, 600 - 300);
            drawInfo('TỈNH THÀNH', formatProvinceName(data.info.province).toUpperCase(), 600);
            drawInfo('NGÀY MỞ', data.info.date, 600 + 300);

            // 7. Small Note
            ctx.font = '400 14px Outfit, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.textAlign = 'center';
            ctx.fillText('Kết quả được đối soát tự động từ hệ thống KQXS Xây Số', 600, 620);

            // Trigger Download
            const link = document.createElement('a');
            link.download = `DoVeSoAI_Win_${data.info.number}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        function showError(msg) {
            processingView.classList.add('hidden');
            errorSection.classList.remove('hidden');

            // Set UI to Error state
            errorSection.className = 'premium-glass border-red-500/30 rounded-3xl p-8 text-center animate-fade-in shadow-2xl';
            document.getElementById('error-icon').classList.remove('hidden');
            document.getElementById('pending-icon').classList.add('hidden');

            document.getElementById('error-title').textContent = 'Oops! Có lỗi rồi';
            errorMsg.textContent = msg || 'Lỗi không xác định';

            const btn = document.getElementById('error-action-btn');
            if (btn) {
                btn.textContent = 'Thử lại';
                btn.className = 'px-10 py-3 bg-red-500/20 text-red-400 rounded-2xl hover:bg-red-500/30 transition-all font-bold min-w-[150px]';
            }
        }

        function showPendingMessage(msg) {
            processingView.classList.add('hidden');
            errorSection.classList.remove('hidden');

            // Set UI to Pending state
            errorSection.className = 'premium-glass border-orange-500/30 rounded-3xl p-8 text-center animate-fade-in shadow-2xl';
            document.getElementById('error-icon').classList.add('hidden');
            document.getElementById('pending-icon').classList.remove('hidden');

            document.getElementById('error-title').textContent = 'Kết quả đang chờ';
            errorMsg.textContent = msg;

            const btn = document.getElementById('error-action-btn');
            if (btn) {
                btn.textContent = 'Quay lại';
                btn.className = 'px-10 py-3 bg-orange-500/20 text-orange-400 rounded-2xl hover:bg-orange-500/30 transition-all font-bold min-w-[150px]';
            }
        }

        // --- Statistics Logic ---
        function renderStatistics() {
            const history = JSON.parse(localStorage.getItem('lottery_history') || '[]');
            let totalWin = 0;
            let luckyCount = 0;
            const scannedCount = history.length;

            history.forEach(item => {
                if (item.isWin && item.win_details) {
                    luckyCount++;
                    item.win_details.forEach(d => totalWin += d.value);
                }
            });

            document.getElementById('stat-total-win').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalWin);
            document.getElementById('stat-scanned').textContent = scannedCount;
            document.getElementById('stat-lucky').textContent = luckyCount;
        }

        function renderResultsTable(results, containerId = 'results-table-container') {
            const container = document.getElementById(containerId);
            if (!results) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            let tableHtml = `
                <div class="premium-glass rounded-2xl overflow-hidden bg-[var(--input-bg)] border-[var(--glass-border)]">
                    <table class="w-full text-sm">
                        <thead class="bg-black/5 text-[10px] uppercase font-bold text-[var(--text-muted)] border-b border-[var(--glass-border)]">
                            <tr>
                                <th class="py-3 px-4 text-left">Giải</th>
                                <th class="py-3 px-4 text-center">Các số trúng</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[var(--glass-border)]">
            `;

            const prizeOrder = ['Giải Đặc Biệt', 'Giải Nhất', 'Giải Nhì', 'Giải Ba', 'Giải Tư', 'Giải Năm', 'Giải Sáu', 'Giải Bảy', 'Giải Tám'];

            // Map results to sorted entries
            const sortedEntries = Object.entries(results).sort((a, b) => {
                const aIdx = prizeOrder.indexOf(a[0]);
                const bIdx = prizeOrder.indexOf(b[0]);
                if (aIdx === -1) return 1;
                if (bIdx === -1) return -1;
                return aIdx - bIdx;
            });

            sortedEntries.forEach(([prize, numbers]) => {
                tableHtml += `
                    <tr>
                        <td class="py-3 px-4 font-bold text-[var(--text-muted)] text-xs">${prize}</td>
                        <td class="py-3 px-4 text-center font-mono tracking-wider text-orange-400 font-bold">${Array.isArray(numbers) ? numbers.join(' - ') : numbers}</td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }

        // --- Settings ---
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');

        apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
        document.getElementById('open-settings').addEventListener('click', () => openModal(settingsModal));
        document.getElementById('close-settings').addEventListener('click', () => closeModal(settingsModal));
        document.getElementById('save-settings').addEventListener('click', () => {
            // Save API Key
            const key = apiKeyInput.value.trim();
            if (key) localStorage.setItem('gemini_api_key', key);
            else localStorage.removeItem('gemini_api_key');

            // Save Theme
            const selectedTheme = themeSelect.value;
            localStorage.setItem('app_theme', selectedTheme);
            applyTheme(selectedTheme);

            closeModal(settingsModal);
        });

        // --- Modal & Back Button Management ---
        const MODAL_STATE = 'modal-open';
        const HISTORY_STATE = 'history-open';
        const RESULTS_STATE = 'results-view';

        function openModal(modal) {
            if (!modal) return;
            modal.style.display = 'flex';
            // Always push a new state when a modal opens, even if we are already in RESULTS_STATE
            window.history.pushState(MODAL_STATE, '');
        }

        function closeModal(modal, isPopState = false) {
            if (!modal) return;
            modal.style.display = 'none';
            if (modal === cameraUI) stopCamera();

            // If we closed it via UI button (not back button), we need to "go back" in history
            if (!isPopState) {
                window.history.back();
            }
        }

        window.addEventListener('popstate', (event) => {
            const state = event.state;

            // 1. Handle Modals & Drawer

            // Close Modals if not in MODAL_STATE
            if (state !== MODAL_STATE) {
                [resultsModal, settingsModal, cameraUI].forEach(modal => {
                    if (modal.style.display === 'flex' || !modal.classList.contains('hidden')) {
                        modal.style.display = 'none';
                        if (modal === cameraUI) stopCamera();
                    }
                });
            }

            // Close History Drawer if not in HISTORY_STATE
            if (state !== HISTORY_STATE) {
                const drawer = document.getElementById('history-drawer');
                const overlay = document.getElementById('history-drawer-overlay');
                if (drawer && drawer.classList.contains('open')) {
                    drawer.classList.remove('open');
                    overlay.classList.remove('visible');
                }
            }

            // 2. Handle Results View: If state is null (Home), reset UI
            if (!state) {
                resetUI();
            }
        });

        // Results Modal Events
        document.getElementById('close-results').addEventListener('click', () => closeModal(resultsModal));
        document.getElementById('close-results-btn').addEventListener('click', () => closeModal(resultsModal));
        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) closeModal(settingsModal);
            if (e.target === resultsModal) closeModal(resultsModal);
        });


        // PWA Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('SW Registered!', reg);
                }).catch(err => {
                    console.log('SW Registration failed!', err);
                });
            });
        }

        // Initialize
        renderHistory();
        renderStatistics();

        // --- Mobile History Drawer ---
        function toggleMobileHistory(isPopState = false) {
            const drawer = document.getElementById('history-drawer');
            const overlay = document.getElementById('history-drawer-overlay');
            if (drawer.classList.contains('open')) {
                drawer.classList.remove('open');
                overlay.classList.remove('visible');
                if (!isPopState) window.history.back();
            } else {
                drawer.classList.add('open');
                overlay.classList.add('visible');
                if (!isPopState) window.history.pushState(HISTORY_STATE, '');
            }
        }
    </script>
</body>

</html>